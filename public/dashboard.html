<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üêä CROC | Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-doughnutlabel@1.0.3/dist/chartjs-plugin-doughnutlabel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body {
      background: linear-gradient(to right, #2c3e50, #4ca1af);
      min-height: 100vh;
      color: #333;
    }

    /* Top navbar */
    .navbar {
      position: sticky; top: 0; z-index: 50;
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      backdrop-filter: blur(6px);
    }
    .nav-left { display: flex; align-items: center; gap: 10px; }
    .brand { font-weight: 700; color: #2c3e50; }
    .nav-links { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .nav-links a, .nav-links button {
      text-decoration: none;
      background: #4ca1af; color: #fff; border: none;
      padding: 8px 12px; border-radius: 8px; cursor: pointer;
      transition: background 0.2s ease;
      font-size: 14px;
    }
    .nav-links a:hover, .nav-links button:hover { background: #357a8a; }

    .profile {
      display: flex; align-items: center; gap: 10px;
      padding: 4px 8px; border-radius: 12px; background: #f5f7f9;
    }
    #profile-img { width: 36px; height: 36px; border-radius: 50%; }
    #profile-text { text-align: right; font-size: 12px; line-height: 1.2; color: #2c3e50; }
    #profile-text b { font-size: 13px; }

    .page {
      display: flex; justify-content: center; align-items: flex-start;
      padding: 24px;
    }
    .card {
      background: #fff; padding: 24px; border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      width: 100%; max-width: 1200px;
    }

    .top-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    .date-today { font-size: 14px; color: #2c3e50; }
    h1 { font-size: 24px; margin-bottom: 10px; color: #2c3e50; }
    #user-info { font-size: 15px; margin-bottom: 16px; line-height: 1.6; }

    .button-group {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 16px;
    }
    .button-group button {
      background: #4ca1af; color: white; border: none; padding: 10px 16px;
      font-size: 14px; border-radius: 8px; cursor: pointer; transition: background 0.3s ease;
    }
    .button-group button:hover { background: #357a8a; }

    .dashboard-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px; margin-top: 28px;
    }
    .chart-box {
      background: white; padding: 16px; border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }
    .total-deals {
      margin-top: 24px; font-size: 16px; color: #2c3e50; text-align: center;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="nav-left">
      <span class="brand">üêä CROC</span>
    </div>
    <div class="nav-links">
      <!-- direct links to other apps -->
      <a href="https://submissions.croccrm.com">Submissions</a>
      <a href="https://dashboard.croccrm.com">Dashboard</a>
      <a href="https://dashboard.croccrm.com/updates">Updates</a>
      <a href="https://dashboard.croccrm.com/api">API</a>
      <button id="logoutBtn">Logout</button>
    </div>
    <div class="profile">
      <div id="profile-text">
        <div><b id="user-name">Loading‚Ä¶</b></div>
        <div id="user-role">Role</div>
      </div>
      <img id="profile-img" src="https://www.gravatar.com/avatar/?d=mp" alt="Profile" />
    </div>
  </div>

  <!-- PAGE -->
  <div class="page">
    <div class="card">
      <div class="top-bar">
        <div class="date-today" id="date-today">üìÖ Today: </div>
      </div>

      <h1>Welcome to Your CROC Dashboard</h1>
      <p id="user-info">Loading user info...</p>

      <!-- Optional quick buttons inside card too -->
      <div class="button-group">
        <button onclick="goToSubmissions()">Submissions</button>
        <button onclick="goToDashboard()">Dashboard</button>
        <button onclick="goToUpdates()">Updates</button>
        <button onclick="goToAPI()">API</button>
      </div>

      <div class="dashboard-grid">
        <div class="chart-box"><canvas id="funnelChart"></canvas></div>
        <div class="chart-box"><canvas id="gaugeToday"></canvas></div>
        <div class="chart-box"><canvas id="gaugeGrowth"></canvas></div>
        <div class="chart-box"><canvas id="forecastChart"></canvas></div>
        <div class="chart-box"><canvas id="sourceChart"></canvas></div>
        <div class="chart-box"><canvas id="productChart"></canvas></div>
      </div>

      <div class="total-deals" id="total-deals">Loading total deals submitted...</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Get Supabase client config
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = await fetch('/config').then(r => r.json());
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Auth gate
    fetch('/auth/me', { credentials: 'include' })
      .then(res => {
        if (!res.ok) throw new Error();
        return res.json();
      })
      .then(data => {
        document.getElementById('user-info').innerHTML = `
          ‚úÖ Logged in as <b>${data.email}</b><br>
          üîê Role: <b>${data.role}</b>
        `;
        document.getElementById('user-name').innerText = data.email;
        document.getElementById('user-role').innerText = data.role;

        const hash = md5(data.email.trim().toLowerCase());
        document.getElementById('profile-img').src = `https://www.gravatar.com/avatar/${hash}?d=mp`;
      })
      .catch(() => {
        alert('Unauthorized. Redirecting to login.');
        location.replace('/login.html');
      });

    // Date
    document.getElementById('date-today').innerText += new Date().toLocaleDateString();

    // Navbar link helpers
    window.goToSubmissions = () => window.location.href = 'https://submissions.croccrm.com';
    window.goToDashboard   = () => window.location.href = 'https://dashboard.croccrm.com';
    window.goToUpdates     = () => window.location.href = 'https://dashboard.croccrm.com/updates';
    window.goToAPI         = () => window.location.href = 'https://dashboard.croccrm.com/api';

    // Logout in both navbar and card
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
      } catch(e) {
        // ignore network blips on logout
      } finally {
        localStorage.setItem('logout', Date.now());
        history.replaceState(null, null, '/login.html');
        window.location.href = '/login.html';
      }
    }
    document.getElementById('logoutBtn').addEventListener('click', logout);
    window.logout = logout; // if you reference it elsewhere

    // Prevent back-button into an authenticated page after logout
    history.pushState(null, null, location.href);
    window.onpopstate = () => {
      const confirmLogout = confirm('Are you sure you want to logout?');
      if (confirmLogout) logout();
      else history.pushState(null, null, location.href);
    };

    // Draw analytics charts
    async function drawCharts() {
      try {
        const { data: allDeals, error: allDealsError } = await supabase.from('deals_submitted').select('*');
        if (allDealsError) throw allDealsError;

        document.getElementById('total-deals').innerText = `üìà Total Deals Submitted: ${allDeals.length}`;

        const today = new Date().toISOString().split('T')[0];

        const { data: todayDeals, error: todayError } = await supabase
          .from('deals_submitted')
          .select('*')
          .gte('creation_date', `${today}T00:00:00`)
          .lte('creation_date', `${today}T23:59:59`);

        if (todayError) console.error('Error fetching today‚Äôs deals:', todayError);

        const todayCount = Array.isArray(todayDeals) ? todayDeals.length : 0;

        new Chart(document.getElementById('gaugeToday'), {
          type: 'doughnut',
          data: { datasets: [{ data: [todayCount, Math.max(10 - todayCount, 0)], backgroundColor: ['#2ECC71', '#ecf0f1'], borderWidth: 0 }] },
          options: {
            rotation: -90, circumference: 180, cutout: '70%',
            plugins: { doughnutlabel: { labels: [{ text: `${todayCount}`, font: { size: 24 } }, { text: 'Today', font: { size: 14 } }] }, legend: { display: false } }
          }
        });

      } catch (err) {
        console.error('Critical dashboard error:', err.message || err);
        document.getElementById('total-deals').innerText = 'Error loading data.';
      }
    }

    const growthPercent = 22;

    new Chart(document.getElementById('gaugeGrowth'), {
      type: 'doughnut',
      data: { datasets: [{ data: [growthPercent, 100 - growthPercent], backgroundColor: ['#F1C40F', '#ecf0f1'], borderWidth: 0 }] },
      options: {
        rotation: -90, circumference: 180, cutout: '70%',
        plugins: { doughnutlabel: { labels: [{ text: `${growthPercent}%`, font: { size: 24 } }, { text: 'Growth', font: { size: 14 } }] }, legend: { display: false } }
      }
    });

    new Chart(document.getElementById('funnelChart'), {
      type: 'bar',
      data: { labels: ['Leads', 'Qualified', 'Proposals', 'Closed'], datasets: [{ label: 'Funnel', data: [120, 90, 45, 20], backgroundColor: '#3498DB' }] },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('forecastChart'), {
      type: 'line',
      data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'], datasets: [{ label: 'Forecast', data: [2, 4, 3, 6, 5], fill: false, borderColor: '#8E44AD', tension: 0.4 }] },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('sourceChart'), {
      type: 'pie',
      data: { labels: ['Organic', 'Referral', 'Paid'], datasets: [{ data: [40, 30, 30], backgroundColor: ['#2ECC71', '#3498DB', '#E67E22'] }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });

    new Chart(document.getElementById('productChart'), {
      type: 'bar',
      data: { labels: ['Product A', 'Product B', 'Product C'], datasets: [{ label: 'Sales', data: [50, 75, 100], backgroundColor: '#E74C3C' }] },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    await drawCharts();
  </script>
</body>
</html>
